argocd-deploy:
  runs-on: ubuntu-latest
  needs: terraform-apply
  permissions:
    contents: read
    id-token: write
  
  defaults:
    run:
      working-directory: .  # Override infra to root directory for argocd deployment
  
  steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.TERRAFORM_DEPLOY_ARN }}
        role-session-name: github-actions-argocd
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: latest

    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.CLUSTER_NAME }}

    - name: Wait for nodes
      run: |
        kubectl wait --for=condition=Ready nodes --all --timeout=300s

    - name: Apply ClusterIssuer
      run: kubectl apply -f cert-manager/cluster-issuer.yaml

    - name: Deploy ArgoCD Application
      run: kubectl apply -f argocd/application.yaml

    - name: Wait for ArgoCD Server
      run: |
        kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n argocd

    - name: Get ArgoCD Password
      run: |
        echo "ArgoCD admin password:"
        kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
        echo ""

    - name: Deployment Complete
      run: |
        echo "Deployment success!"